name: Security & Secret Scan

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  security-audit:
    name: Dependency audit (pip-audit)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install pip-audit
        run: python -m pip install --upgrade pip setuptools wheel && python -m pip install pip-audit
      - name: Run pip-audit against core requirements
        run: |
          if [ -f requirements-core.txt ]; then
            python -m pip install -r requirements-core.txt --no-deps --no-build-isolation || true
            python -m pip check || true
            pip-audit -r requirements-core.txt --format json -o pip_audit.json || true
            cat pip_audit.json || true
          elif [ -f requirements.txt ]; then
            python -m pip install -r requirements.txt --no-deps --no-build-isolation || true
            python -m pip check || true
            pip-audit -r requirements.txt --format json -o pip_audit.json || true
            cat pip_audit.json || true
          else
            echo 'No requirements file found'
          fi

  secret-scan:
    name: Secret scan (basic)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Quick grep for secrets
        run: |
          set -e || true
          grep -R --line-number -I --exclude-dir=.git -E "api_key|apikey|secret|password|token|AKIA|BEGIN RSA PRIVATE KEY|PRIVATE_KEY|ACCESS_KEY|SECRET_KEY|pwd=" . || true
      - name: Run detect-secrets (optional)
        run: |
          python -m pip install detect-secrets || true
          if command -v detect-secrets >/dev/null 2>&1; then
            detect-secrets scan --all-files || true
          else
            echo 'detect-secrets not available'
          fi
